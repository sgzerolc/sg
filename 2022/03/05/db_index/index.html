<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="DBMS’s execution engine needs to access pages before doing operation on those. Design decisions when implementing data structures for the DBMS:  Data organization: memory layout and information to sto">
<meta property="og:type" content="article">
<meta property="og:title" content="db index">
<meta property="og:url" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/index.html">
<meta property="og:site_name" content="steins gate zero">
<meta property="og:description" content="DBMS’s execution engine needs to access pages before doing operation on those. Design decisions when implementing data structures for the DBMS:  Data organization: memory layout and information to sto">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7503728.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7504450.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7504407.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7509790.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7510112.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7510099.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7510352.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7510635.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7510667.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7511632.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7513367.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7514359.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7515275.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7517327.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7517457.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7517477.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7517887.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7517956.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7517996.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7569559.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7578914.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7578988.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7579194.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7579249.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7579810.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7580430.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7581006.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7581138.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7581440.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7581987.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7584309.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7584321.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7584401.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7590990.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7591456.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7591517.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7591600.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7594900.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7595740.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7595952.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7597088.png">
<meta property="article:published_time" content="2022-03-04T16:00:00.000Z">
<meta property="article:modified_time" content="2022-06-27T02:13:48.655Z">
<meta property="article:author" content="Sam Li">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sgzerolc.github.io/sg/2022/03/05/db_index/Screenshot-7503728.png">
    
    
      
        
          <link rel="shortcut icon" href="/sg/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/sg/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/sg/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>db index</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/sg/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/sg/">Home</a></li><!--
     --><!--
       --><li><a href="/sg/about/">About</a></li><!--
     --><!--
       --><li><a href="/sg/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/sg/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/sg/CV/">CV</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/sg/2022/03/12/22/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/sg/2022/03/05/hw3_dp/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://sgzerolc.github.io/sg/2022/03/05/db_index/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&text=db index"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&is_video=false&description=db index"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=db index&body=Check out this article: https://sgzerolc.github.io/sg/2022/03/05/db_index/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&name=db index&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://sgzerolc.github.io/sg/2022/03/05/db_index/&t=db index"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#hash-tables"><span class="toc-number">1.</span> <span class="toc-text">hash tables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Static-hashing-schema"><span class="toc-number">1.1.</span> <span class="toc-text">Static hashing schema</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-hashing-schema"><span class="toc-number">1.2.</span> <span class="toc-text">Dynamic hashing schema</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#b-tree"><span class="toc-number">2.</span> <span class="toc-text">b+ tree</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview"><span class="toc-number">2.1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#disign-choices"><span class="toc-number">2.2.</span> <span class="toc-text">disign choices</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#optimizations"><span class="toc-number">2.3.</span> <span class="toc-text">optimizations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Index"><span class="toc-number">3.</span> <span class="toc-text">Index</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Trie-index"><span class="toc-number">3.1.</span> <span class="toc-text">Trie index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#radix-tree"><span class="toc-number">3.2.</span> <span class="toc-text">radix tree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inverted-index"><span class="toc-number">3.3.</span> <span class="toc-text">inverted index</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#concurrency-control"><span class="toc-number">4.</span> <span class="toc-text">concurrency control</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Locks-vs-latches"><span class="toc-number">4.1.</span> <span class="toc-text">Locks vs. latches</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Latch-designs"><span class="toc-number">4.2.</span> <span class="toc-text">Latch designs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice"><span class="toc-number">4.3.</span> <span class="toc-text">Practice</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        db index
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Sam Li</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-03-04T16:00:00.000Z" itemprop="datePublished">2022-03-05</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/sg/categories/computer-systems/">computer systems</a> › <a class="category-link" href="/sg/categories/computer-systems/15-445-database/">15-445 database</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>DBMS’s execution engine needs to access pages before doing operation on those.</p>
<p>Design decisions when implementing data structures for the DBMS:</p>
<ol>
<li>Data organization: memory layout and information to store -&gt; access</li>
<li>Concurrency: multiple threads to access without causing problems -&gt; efficient access</li>
</ol>
<p>There are two types of data structures:hash table, trees.</p>
<h2 id="hash-tables"><a class="header-anchor" href="#hash-tables">¶</a>hash tables</h2>
<ol>
<li>
<p>Complexity: space: O(n); runtime: amortized O(1) lookup</p>
</li>
<li>
<p>hash tables implementations:</p>
<ul>
<li>
<p>hashing functions: collision rate</p>
</li>
<li>
<p>schemes: <em>handle key collisions</em> after hashing</p>
</li>
</ul>
</li>
</ol>
<h3 id="Static-hashing-schema"><a class="header-anchor" href="#Static-hashing-schema">¶</a>Static hashing schema</h3>
<p>The size of the hash table is fixed. DBMS has to rebuild a larger hash tables if it runs out of storage space.</p>
<p>Assume: knowing the number of elements it wants to store.</p>
<ol>
<li>
<p>Linear probe hashing</p>
<ul>
<li>
<p>collision: linearly seach the adjacent slots until an open one is found</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7503728.png" class="" title="Screenshot-7503728">
</li>
<li>
<p>Non-unique keys: the same key may be associated with multiple different values or tuples</p>
<ul>
<li>approach 1: separate linked list</li>
<li>approach 2: redundant keys: store the same key multiple times in the table</li>
</ul>
</li>
<li>
<p>deletion: removing the entry from the slot -&gt; can’t find the slots having collisions with the deleted one.</p>
<ul>
<li>
<p>approach 1: tombstone: instead of deletion, replace it with magic entry indicating to keep scanning for future lookups.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7504450.png" class="" title="Screenshot-7504450">
</li>
<li>
<p>Approach 2: movement:  shift the adjacent data after deleting an entry to fill the now empty slot.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7504407.png" class="" title="Screenshot-7504407">
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Robin Hood Hashing: steals slots from “rich” keys and give them to “poor” keys</p>
<p>Each key tracks the number of positions they are from where its <em>optimal position</em> in the table</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7509790.png" class="" title="Screenshot-7509790">
</li>
<li>
<p>Cuckoo Hashing: Use multiple hash tables with different hash function seeds.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7510112.png" class="" title="Screenshot-7510112">
<img src="/sg/2022/03/05/db_index/Screenshot-7510099.png" class="" title="Screenshot-7510099">
</li>
</ol>
<h3 id="Dynamic-hashing-schema"><a class="header-anchor" href="#Dynamic-hashing-schema">¶</a>Dynamic hashing schema</h3>
<p>property: Dynamic hash tables resize themselves on demand</p>
<ol>
<li>
<p>Chained hashing: linked list to handle collisions</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7510352.png" class="" title="Screenshot-7510352">
</li>
<li>
<p>extendible hashing: splits buckets in case of letting chains to grow forever</p>
<p>Local/global depth bit: track slots</p>
<p>problem 1: what to split: data movement: move data within the buckets of the <em>split chain</em>; all other buckets are left untouched.</p>
<p>problem 2: when to split: if the bucket is full, splits the bucket and reshuffle its elements.</p>
<p>observe: the changed pointers to slots are on the split chain.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7510635.png" class="" title="Screenshot-7510635">
<img src="/sg/2022/03/05/db_index/Screenshot-7510667.png" class="" title="Screenshot-7510667">
</li>
<li>
<p>linear hashing: maintains a split pointer that keeps track of the next bucket to split instead of immediately splitting a bucket when it overflows.</p>
<p>Procedures:</p>
<ol>
<li>Add a new slot in split pointers, and create a new hash function</li>
<li>Decide whether to apply the new hash fuction on new query index.</li>
<li>Delete original hash function and replace with new hash function when run out of slots.</li>
</ol>
<ul>
<li>
<p>Insertion -&gt; when buckets are full</p>
</li>
<li>
<p>Deletion: reverse of insertion: pointers move backwards -&gt; when buckets are empty</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7511632.png" class="" title="Screenshot-7511632">
<img src="/sg/2022/03/05/db_index/Screenshot-7513367.png" class="" title="Screenshot-7513367">
</li>
</ul>
</li>
</ol>
<p>​</p>
<h2 id="b-tree"><a class="header-anchor" href="#b-tree">¶</a>b+ tree</h2>
<ol>
<li>table index: index of a table’s attributes. The table is stored in the sort order specified by the primary key. Can be either heap- or index-organized storage</li>
<li>Trade-off on the number of indexes to create per database: storage overhead Vs. maintenance overhead</li>
</ol>
<h3 id="Overview"><a class="header-anchor" href="#Overview">¶</a>Overview</h3>
<ol>
<li>
<p>b+ tree: a self-balancing tree data structure that keeps data sorted and allows searches, sequential access, insertion, and deletions in O(log(n)). Good at read/write large blocks of data.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7514359.png" class="" title="Screenshot-7514359">
</li>
<li>
<p>difference with b tree: b+ tree stores values only in leaf nodes; b tree store values in all nodes.</p>
</li>
</ol>
<p><strong>Structure:</strong></p>
<ol>
<li>
<p>Key-value pair: inner node: store pointers; leaf node: values.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7515275.png" class="" title="Screenshot-7515275">
<ul>
<li>Leaf node values have two approaches: 1) record IDs: pointers to the location of tuple; 2) tuple data: store the actual contents of the tuple in each node</li>
</ul>
</li>
<li>
<p>node: Arrays at every node are sorted by the keys.</p>
</li>
</ol>
<p><strong>Operations:</strong></p>
<ol>
<li>
<p>Insertion:</p>
<p>Split leaves when the tree got too full</p>
<ul>
<li>Leaf node: copy up middle key</li>
<li>inner node: push up middle key</li>
</ul>
</li>
<li>
<p>deletion</p>
<p>Redistribute by borrowing from sibling when lead is not half full; Merge nodes when redistribution fails.</p>
<ul>
<li>Leaf node: delete the key</li>
<li>Inner node: delete entry in parent pointing to the key</li>
</ul>
</li>
<li>
<p>selection conditions: Support search provides <em>any</em> of the attributes of the search key.</p>
<p>-&gt; Hash index requires <em>all</em> attributes in the search key.</p>
</li>
<li>
<p>Non-unique indexes</p>
<p>like hash tables: 1) duplicate keys, 2)store value lists.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7517327.png" class="" title="Screenshot-7517327">
</li>
<li>
<p>duplicate keys approaches</p>
<ul>
<li>
<p>Append record IDs</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7517457.png" class="" title="Screenshot-7517457">
</li>
<li>
<p>overflow leafnodes: Allow leaf nodes to spill into overflow nodes that contain<br>
the duplicate keys.</p>
<ul>
<li>complex to maintain</li>
</ul>
<img src="/sg/2022/03/05/db_index/Screenshot-7517477.png" class="" title="Screenshot-7517477">
</li>
</ul>
</li>
<li>
<p>Clustered indexes: If a table does not contain a primary key, the DBMS will automatically make a hidden row id primary key</p>
<p>(think about VEB tree)</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7517887.png" class="" title="Screenshot-7517887">
<p>Sorting:</p>
<ol>
<li>heap clustering: tuples are sorted in the heap’s pages using the order specified by a clustering index. DBMS can jump directly to the pages if clustering index’s attributes are used to access tuples</li>
</ol>
<img src="/sg/2022/03/05/db_index/Screenshot-7517956.png" class="" title="Screenshot-7517956">
<ol start="2">
<li>index scan page sorting: sort all the tuples that it needs based on their page id.</li>
</ol>
<img src="/sg/2022/03/05/db_index/Screenshot-7517996.png" class="" title="Screenshot-7517996">
</li>
</ol>
<h3 id="disign-choices"><a class="header-anchor" href="#disign-choices">¶</a>disign choices</h3>
<ol>
<li>
<p>node size</p>
<ul>
<li>
<p>~ storage device: the faster the storage device is, the smaller the node size is. Because we want to reduce the number of accesses in slower device like HDD compared with RAM. And the amortized runtime of read over large chunk of data is more optimal.</p>
</li>
<li>
<p>~ workload: there are two types of workload: point query; sequential scan. A point query would prefer small pages to reduce extra info while sequential scan likes large pages to reduce the number of fetches.</p>
</li>
</ul>
</li>
<li>
<p>merge threshold</p>
<ul>
<li>like lazy allocation in os</li>
<li>Delaying merge to reduce the amount of reorganization like expensive write latches.</li>
</ul>
</li>
<li>
<p>variable length keys</p>
<ul>
<li>
<p>good in a way: 1)space saving: reduce a small subset of large keys lead to lot of wasted space</p>
</li>
<li>
<p>approach 1: pointers  -&gt; embedded devices: registers, cache</p>
<p>Store the keys as pointers to the tuple’s attribute</p>
</li>
<li>
<p>approach 2: Variable Length Nodes -&gt; infeasible: large memory management overhead</p>
<p>allow nodes to have variable length.</p>
</li>
<li>
<p>approach 3: padding -&gt; infeasible: big waste of memory</p>
<p>Set each key’s size to the size of the max key and pad out all the shorter keys.</p>
</li>
<li>
<p>approach 4: key map/indirection</p>
<p>Embed an array of pointers that map to the key + value list within the node. Place prefix of each key alongside the index.</p>
<ul>
<li>unlike approach 1, a4 stores the dictionary index that needs small space not the key pointers, which allows storing prefix alongside of the index.</li>
</ul>
<img src="/sg/2022/03/05/db_index/Screenshot-7569559.png" class="" title="Screenshot-7569559">
</li>
</ul>
</li>
<li>
<p>Intra-node search: search within the node</p>
<ul>
<li>
<p>A1: linear: Scan node keys from beginning to end.</p>
</li>
<li>
<p>A2: binary: Jump to middle key, pivot left/right depending on comparison</p>
</li>
<li>
<p>A3: interpolation: Approximate location of desired key based on known distribution of keys -&gt; infeasible: limited applicability to keys with certain properties and complexity, only seen in academic use</p>
<p>take advantage of metadata(max, min ,avg …) and infer approximate location</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7578914.png" class="" title="Screenshot-7578914">
</li>
</ul>
</li>
</ol>
<h3 id="optimizations"><a class="header-anchor" href="#optimizations">¶</a>optimizations</h3>
<ol>
<li>
<p>Prefix compression: extract prefix and store unique suffix for each key -&gt; keys in the same node have overlapping prefix</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7578988.png" class="" title="Screenshot-7578988">
</li>
<li>
<p>duplication: write key once and maintain a list of record ids with the key -&gt; non-unique keys</p>
<p>~ MVCC</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7579194.png" class="" title="Screenshot-7579194">
</li>
<li>
<p>suffix truncation:  only storing the minimum differentiating prefix of each key at a given inner node.  -&gt; No need to search the entire key</p>
<ul>
<li>leave few redundant digits: fault tolerance -&gt; indeterminable insertion/deletion  due to an identical prefix</li>
</ul>
<img src="/sg/2022/03/05/db_index/Screenshot-7579249.png" class="" title="Screenshot-7579249">
</li>
<li>
<p>bulk insert: sort the keys and build the index from the bottom up -&gt; fastest way to build a new b+ tree</p>
<ul>
<li>Trade-off: leaving vacancy or not when packing the leaves depends on context</li>
</ul>
<p>Keys: 3, 7, 9, 13, 6, 1; sorted keys: 1, 3, 6, 7, 9, 13</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7579810.png" class="" title="Screenshot-7579810">
</li>
<li>
<p>Pointer swizzling: store raw pointers instead of page ids for pinned page in the buffer pool  -&gt; reduce expensive buffer pool fetches</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7580430.png" class="" title="Screenshot-7580430">
</li>
</ol>
<h2 id="Index"><a class="header-anchor" href="#Index">¶</a>Index</h2>
<ol>
<li>
<p>what is index: provide fast access to data items.</p>
</li>
<li>
<p>methods</p>
<ul>
<li>
<p>implicit indexes: provide primary key with integerity constraints</p>
</li>
<li>
<p>partial indexes: Create an index on a subset of the entire table. -&gt; reduce full page fetches overhead</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7581006.png" class="" title="Screenshot-7581006">
</li>
<li>
<p>covering indexes(index-only scans): locate data records in the table and not to return data -&gt; reduces contention on the DBMS’s buffer pool resources</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7581138.png" class="" title="Screenshot-7581138">
</li>
<li>
<p>index include columns: Embed additional columns in indexes<br>
to support index-only queries.</p>
<ul>
<li>Extra columns are only stored in the leaf nodes and are not part of the search key</li>
</ul>
<img src="/sg/2022/03/05/db_index/Screenshot-7581440.png" class="" title="Screenshot-7581440">
</li>
<li>
<p>Function/expression indexes: use expressions when declaring an index. store the output of a function or expression as the key instead of the original value. -&gt; ? which queries can use that index</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7581987.png" class="" title="Screenshot-7581987">
</li>
</ul>
</li>
</ol>
<h3 id="Trie-index"><a class="header-anchor" href="#Trie-index">¶</a>Trie index</h3>
<ol>
<li>
<p>make oberservations: the inner node keys in a B+Tree cannot tell you whether or not a key exists in the index -&gt; at least one buffer pool page miss per level in the tree</p>
</li>
<li>
<p>approach: trie index</p>
<ul>
<li>
<p>Properties: complexity in operations and space</p>
</li>
<li>
<p>trie key span: digital representation of keys</p>
<ul>
<li>
<p>Fan-out of node, height of tree</p>
<p>图中：空表示该值不存在，指针指向下一个位置，使用0/1的二进制表示</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7584309.png" class="" title="Screenshot-7584309">
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="radix-tree"><a class="header-anchor" href="#radix-tree">¶</a>radix tree</h3>
<p>variant of trie index. Omit all nodes with only a single child.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7584321.png" class="" title="Screenshot-7584321">
<img src="/sg/2022/03/05/db_index/Screenshot-7584401.png" class="" title="Screenshot-7584401">
<h3 id="inverted-index"><a class="header-anchor" href="#inverted-index">¶</a>inverted index</h3>
<ol>
<li>
<p>make observations: Tree indexs above are useful for point and range queries; not good for keyword searches</p>
</li>
<li>
<p>Approach: inverted index(full-text search index) -&gt; keyword search</p>
<p>stores a mapping of words to records that contain those words in the target attribute.</p>
</li>
<li>
<p>supported query type:</p>
<ul>
<li>phrase searches: records that contain a list of words in the given order</li>
<li>proximity searches: two words occur within n words of each other</li>
<li>wildcard searches:words that match some pattern (e.g., regular expression).</li>
</ul>
</li>
<li>
<p>design decisions</p>
<ul>
<li>decision 1: what to store: depend on the context</li>
<li>decision 2: when to update: update is expensive. So stage updates and then update in batches</li>
</ul>
</li>
</ol>
<h2 id="concurrency-control"><a class="header-anchor" href="#concurrency-control">¶</a>concurrency control</h2>
<ol>
<li>make observations: multi-threads world means that cpu cores and disk I/O stalls matters.</li>
<li>come up with a protocol: a protocol needs criteria
<ul>
<li><em>logical correctness</em>: thread view</li>
<li>Physical correctness: internal representation of object soundness -&gt; memory leak</li>
</ul>
</li>
</ol>
<h3 id="Locks-vs-latches"><a class="header-anchor" href="#Locks-vs-latches">¶</a>Locks vs. latches</h3>
<ol>
<li>Locks: protects the contents of a database (e.g., tuples, tables, databases) from other transactions -&gt; object view</li>
<li>Latches: protects critical sections the DBMS’s internal data structures (e.g., data structure, regions of memory) from other threads -&gt; operation view
<ul>
<li>Read mode: Multiple threads are allowed to read the same item at the same time</li>
<li>write mode: Only one thread is allowed to access the item.</li>
</ul>
</li>
</ol>
<h3 id="Latch-designs"><a class="header-anchor" href="#Latch-designs">¶</a>Latch designs</h3>
<p>latch takes advantage of CPU’s atomic compare-and-swap(CAS) instruction. A thread can check the contents of a memory location to see whether it has a certain value.</p>
<p>Definition: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15059958/what-is-a-scalable-lock">scalability</a> of latches means if latches perform well when there is a lot of contention.</p>
<p>Approaches:</p>
<ol>
<li>
<p>Blocking OS mutex: os build-in mutex infra.</p>
<p>User space -&gt; kernel space -&gt; fail/blocked -&gt; descheduled</p>
<ul>
<li>
<p>Pro: no extra work for DBMS</p>
</li>
<li>
<p>Con: ~ os scheduling: Non-scalable (about 25ns per lock/unlock invocation)</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::mutex m;</span><br><span class="line">m.<span class="built_in">lock</span>();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">m.<span class="built_in">unlock</span>();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Test-and-set spin latch(TAS)</p>
<p>use CAS to update value -&gt; fail -&gt; DBMS’s choice now(keep trying/descheduled)</p>
<ul>
<li>Spin latch: a location in memory that  threads try to update.</li>
<li>pro: efficient operations</li>
<li>con: not scalable nor cache-friendly</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ex: std::atomic&lt;T&gt;</span></span><br><span class="line">std::atomic_flag latch;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">while</span> (latch.<span class="built_in">test_and_set</span>(...))&#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Reader-writer locks</p>
<p>based on two modes of latches, keep track of reads and writes.</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7590990.png" class="" title="Screenshot-7590990">
<ul>
<li>
<p>pro: concurrent reads</p>
</li>
<li>
<p>con: extra work for DBMS management; larger storage overhead</p>
</li>
</ul>
</li>
</ol>
<h3 id="Practice"><a class="header-anchor" href="#Practice">¶</a>Practice</h3>
<ol>
<li>
<p>Hash table</p>
<ul>
<li>
<p><strong>observation 1: Limited ways threads access the data structure（top-down)</strong> -&gt; no deadlock problem -&gt; global latch</p>
</li>
<li>
<p>Trade-off: Parallelism vs. storage, computational overhead of accessing the table, efficiency</p>
</li>
<li>
<p>approach 1: page latches</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7591456.png" class="" title="Screenshot-7591456">
<img src="/sg/2022/03/05/db_index/Screenshot-7591517.png" class="" title="Screenshot-7591517">
</li>
<li>
<p>approach 2: slot latches</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7591600.png" class="" title="Screenshot-7591600">
</li>
</ul>
</li>
<li>
<p>b+tree</p>
<p>Observation 1: several way to access b+ tree(top-down/sibling pointers/…) -&gt; come up with a protocol to allow multiple threads to read and update a b+ tree</p>
<p>Problem 1: modify same node at the same time</p>
<p><u>Problem 2</u>: one thread traversing the tree while another thread splits/merges nodes</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7594900.png" class="" title="Screenshot-7594900">
<ul>
<li>
<p>Solution: latch crabbing/coupling protocol -&gt; top-down direction</p>
<ul>
<li>define safe node: A “safe” node is one that will not split or merge when updated (not full on insertion or more than half full on deletion -&gt; write view(insert/delete)</li>
<li>Procedures:
<ol>
<li>get latch for the parent</li>
<li>get latch for the child</li>
<li>release latch for the parent if it is deemed “safe”</li>
</ol>
</li>
</ul>
</li>
<li>
<p>Basic latch crabbing protocol for operations</p>
<ul>
<li>
<p>Search: top-down</p>
</li>
<li>
<p>Insert/delete: If latched child is safe, release latches on all its ancestors</p>
<p>Delete 38:<img src="/sg/2022/03/05/db_index/Screenshot-7595740.png" class="" title="Screenshot-7595740"></p>
<p>Insert 25:<img src="/sg/2022/03/05/db_index/Screenshot-7595952.png" class="" title="Screenshot-7595952"></p>
</li>
</ul>
</li>
<li>
<p>observation 2: first step of all the updates on the b+tree is <strong>taking a write latch on the root.</strong> -&gt; <strong>bottleneck with higher concurrency</strong></p>
<ul>
<li>No need to acquire write latch on the safe node update.</li>
</ul>
</li>
<li>
<p>Better latching algorithm: assume the target leaf node is safe, use READ latches on the way. If it the node is not safe, apply the old method(WRITE latch on the root)</p>
</li>
</ul>
<p><u>Problem 3</u>: leaf node scan -&gt; dead lock</p>
<ul>
<li>
<p>observation: threads acquire locks in two directions at the same time</p>
<img src="/sg/2022/03/05/db_index/Screenshot-7597088.png" class="" title="Screenshot-7597088">
</li>
</ul>
<p>Problem 4: delayed parent updates</p>
<p>Problem 5: versioned latch coupling</p>
</li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/sg/">Home</a></li>
         
          <li><a href="/sg/about/">About</a></li>
         
          <li><a href="/sg/categories/">Category</a></li>
         
          <li><a href="/sg/archives/">Writing</a></li>
         
          <li><a href="/sg/CV/">CV</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#hash-tables"><span class="toc-number">1.</span> <span class="toc-text">hash tables</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Static-hashing-schema"><span class="toc-number">1.1.</span> <span class="toc-text">Static hashing schema</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-hashing-schema"><span class="toc-number">1.2.</span> <span class="toc-text">Dynamic hashing schema</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#b-tree"><span class="toc-number">2.</span> <span class="toc-text">b+ tree</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview"><span class="toc-number">2.1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#disign-choices"><span class="toc-number">2.2.</span> <span class="toc-text">disign choices</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#optimizations"><span class="toc-number">2.3.</span> <span class="toc-text">optimizations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Index"><span class="toc-number">3.</span> <span class="toc-text">Index</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Trie-index"><span class="toc-number">3.1.</span> <span class="toc-text">Trie index</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#radix-tree"><span class="toc-number">3.2.</span> <span class="toc-text">radix tree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inverted-index"><span class="toc-number">3.3.</span> <span class="toc-text">inverted index</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#concurrency-control"><span class="toc-number">4.</span> <span class="toc-text">concurrency control</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Locks-vs-latches"><span class="toc-number">4.1.</span> <span class="toc-text">Locks vs. latches</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Latch-designs"><span class="toc-number">4.2.</span> <span class="toc-text">Latch designs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice"><span class="toc-number">4.3.</span> <span class="toc-text">Practice</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://sgzerolc.github.io/sg/2022/03/05/db_index/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&text=db index"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&is_video=false&description=db index"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=db index&body=Check out this article: https://sgzerolc.github.io/sg/2022/03/05/db_index/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&title=db index"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://sgzerolc.github.io/sg/2022/03/05/db_index/&name=db index&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://sgzerolc.github.io/sg/2022/03/05/db_index/&t=db index"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    Sam Li
  </div>
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/sg/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
