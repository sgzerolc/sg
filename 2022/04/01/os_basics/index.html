<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Design points Interfaces  Process File descriptor and I&#x2F;O Pipe Fs   Organization Virtual memory techniques  Page table   Traps  Trap machanism Page fault exceptions Device interrupts   Parallelism">
<meta property="og:type" content="article">
<meta property="og:title" content="Intro to xv6">
<meta property="og:url" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/index.html">
<meta property="og:site_name" content="steins gate zero">
<meta property="og:description" content="Design points Interfaces  Process File descriptor and I&#x2F;O Pipe Fs   Organization Virtual memory techniques  Page table   Traps  Trap machanism Page fault exceptions Device interrupts   Parallelism">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/boot.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/pt.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/vm.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/Screenshot-4834686.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/trap.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/Screenshot-6244321.png">
<meta property="og:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/Screenshot-9679149.png">
<meta property="article:published_time" content="2022-03-31T22:00:00.000Z">
<meta property="article:modified_time" content="2024-01-07T15:48:06.659Z">
<meta property="article:author" content="Sam Li">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sgzerolc.github.io/sg/2022/04/01/os_basics/boot.png">
    
    
      
        
          <link rel="shortcut icon" href="/sg/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/sg/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/sg/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Intro to xv6</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/sg/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/sg/">Home</a></li><!--
     --><!--
       --><li><a href="/sg/about/">About</a></li><!--
     --><!--
       --><li><a href="/sg/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/sg/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/sg/CV/">CV</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/sg/2022/04/06/os_virtual_machine/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/sg/2022/03/30/april/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://sgzerolc.github.io/sg/2022/04/01/os_basics/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&text=Intro to xv6"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&is_video=false&description=Intro to xv6"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Intro to xv6&body=Check out this article: https://sgzerolc.github.io/sg/2022/04/01/os_basics/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&name=Intro to xv6&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&t=Intro to xv6"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Design points</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Interfaces</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text">Process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text">File descriptor and I&#x2F;O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.3.</span> <span class="toc-text">Pipe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.4.</span> <span class="toc-text">Fs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">Organization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">Virtual memory techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">4.1.</span> <span class="toc-text">Page table</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">Traps</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.1.</span> <span class="toc-text">Trap machanism</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.2.</span> <span class="toc-text">Page fault exceptions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.3.</span> <span class="toc-text">Device interrupts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">Parallelism</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">6.1.</span> <span class="toc-text">Lock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">6.2.</span> <span class="toc-text">Threads</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">File systems</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">case study: ext3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">Network stack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">case study: meltdown</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text">case study: RCU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">11.1.</span> <span class="toc-text">Design</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">11.2.</span> <span class="toc-text">Mechanisms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">11.3.</span> <span class="toc-text">Usages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">12.</span> <span class="toc-text">Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.1.</span> <span class="toc-text">C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.2.</span> <span class="toc-text">RISC-V convention</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.3.</span> <span class="toc-text">GDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.4.</span> <span class="toc-text">Lookup table</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">13.</span> <span class="toc-text">Related readings</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Intro to xv6
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Sam Li</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-03-31T22:00:00.000Z" itemprop="datePublished">2022-04-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/sg/categories/computer-systems/">computer systems</a> › <a class="category-link" href="/sg/categories/computer-systems/6-s081-operating-systems/">6.s081 operating systems</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <div class="toc">
<!-- toc -->
<ul>
<li><a href="#design-points">Design points</a></li>
<li><a href="#interfaces">Interfaces</a>
<ul>
<li><a href="#process">Process</a></li>
<li><a href="#file-descriptor-and-i-o">File descriptor and I/O</a></li>
<li><a href="#pipe">Pipe</a></li>
<li><a href="#fs">Fs</a></li>
</ul>
</li>
<li><a href="#organization">Organization</a></li>
<li><a href="#virtual-memory-techniques">Virtual memory techniques</a>
<ul>
<li><a href="#page-table">Page table</a></li>
</ul>
</li>
<li><a href="#traps">Traps</a>
<ul>
<li><a href="#trap-machanism">Trap machanism</a></li>
<li><a href="#page-fault-exceptions">Page fault exceptions</a></li>
<li><a href="#device-interrupts">Device interrupts</a></li>
</ul>
</li>
<li><a href="#parallelism">Parallelism</a>
<ul>
<li><a href="#lock">Lock</a></li>
<li><a href="#threads">Threads</a></li>
</ul>
</li>
<li><a href="#file-systems">File systems</a></li>
<li><a href="#case-study-ext3">case study: ext3</a></li>
<li><a href="#network-stack">Network stack</a></li>
<li><a href="#case-study-meltdown">case study: meltdown</a></li>
<li><a href="#case-study-rcu">case study: RCU</a>
<ul>
<li><a href="#design">Design</a></li>
<li><a href="#mechanisms">Mechanisms</a></li>
<li><a href="#usages">Usages</a></li>
</ul>
</li>
<li><a href="#basics">Basics</a>
<ul>
<li><a href="#c">C</a></li>
<li><a href="#risc-v-convention">RISC-V convention</a></li>
<li><a href="#gdb">GDB</a></li>
<li><a href="#lookup-table">Lookup table</a></li>
</ul>
</li>
<li><a href="#related-readings">Related readings</a></li>
</ul>
<!-- tocstop -->
</div>
<h2><span id="design-points">Design points</span><a href="#design-points" class="header-anchor">¶</a></h2>
<ol>
<li>Few mechanisms provide enough generality: xv6 provides a Unix-like interface which contains the basic concepts to resolve the tradeoff between supporting many devices and using a simple interface.</li>
<li>What is one syscall in xv6? Xv6 has one <code>kernel</code> runs programs (<code>process</code>), process in the user space calls (<code>syscall</code>) kernel to provide services.
<ul>
<li>Each process has memory which cantains instructions, data and stack. Stacks manages procedure calls.</li>
<li>Kernel provides services as process, memory, fd, pipes, fs.</li>
<li>Shell is a command-line user interface. It’s a user program.</li>
</ul>
</li>
<li>Chap1: xv6 provides simplicity and generality for Unix-like os flavour but it does not follow POSIX standard and follow users notion. All xv6 processes run as root. The functionalities it misses are user-level threads, … (Intended to develop this)</li>
<li>Chap2:
<ul>
<li>xv6 runs entire os in kernel. The concept is monolithic though it provides less kernel services than some microkernel.</li>
<li>xv6’s process has one thread. Modern os supports several threads within a process</li>
</ul>
</li>
<li>Chap3: 3-level page table to save memory when most va is not mapped.</li>
<li>Chap4:  Xv6 kernel handles all traps. It has separate io path for three cases for convenience (<s>for commonality only single path</s>): traps from user space, traps from kernel space, timer interrupts.
<ul>
<li>k/u isolation security: Xv6 simplifies the CPU h/w’s trap handling sequence by making kernel s/w switch to kpgtbl, kstack and save regs except pc.</li>
</ul>
</li>
<li>Chap5: device and timer interrupts while executing in the kernel and user programs.</li>
<li>Chap7: the scheduling policy is running processes in turn as is <code>round robin</code></li>
<li>Chap8: xv6 provides Unix-like fs and stores data on a virtio disk for persistence.</li>
</ol>
<h2><span id="interfaces">Interfaces</span><a href="#interfaces" class="header-anchor">¶</a></h2>
<h3><span id="process">Process</span><a href="#process" class="header-anchor">¶</a></h3>
<ol>
<li>Xv6 time-shares processes by switching the available CPU between the process waiting to execute.</li>
<li>Xv6 allocates memory for each process implicitly:
<ul>
<li><code>fork</code> allocates the enough memory for its child process (copy of the parent’s memory), <code>exec</code> allocates the memory for the executable file</li>
<li>run-time memory is changed by <code>sbrk(n)</code>, which grows the data memory of process by n.</li>
</ul>
</li>
<li>Xv6 manages processes:
<ul>
<li>create: <code>fork</code></li>
<li>close: <code>exit</code>, <code>wait</code> (wait for the child’s process)</li>
<li>replace the process memory of calling process with new file img: <code>exec</code></li>
</ul>
</li>
</ol>
<h3><span id="file-descriptor-and-i-o">File descriptor and I/O</span><a href="#file-descriptor-and-i-o" class="header-anchor">¶</a></h3>
<ol>
<li>
<p>File descriptors abstract I/O objects like device, file, pipes.</p>
</li>
<li>
<p>Every fd has its own offset. Fds share the offset of the file if the fd is crated by <code>dup</code> or <code>fork</code>. That’s why I/O direction in the shell is easy to implement.</p>
<ul>
<li>
<p><code>fork</code> copies parent’s fd table as well while <code>exec</code> preserves the fd table of calling process. So exec can change the original fd.</p>
</li>
<li>
<p><code>dup</code>: <code>ls existing-file non-existing-file &gt; tmp1 2&gt;&amp;1</code>, &amp;1 means dup(1) which shares err files with output file tmp1, therefore tmp1 would have correct and wrong ones.</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cat &lt; input.txt </span></span><br><span class="line"><span class="comment">// Read from stdin</span></span><br><span class="line"><span class="type">char</span> *argv[<span class="number">2</span>];</span><br><span class="line">argv[<span class="number">0</span>] = <span class="string">&#x27;cat&#x27;</span>;</span><br><span class="line">argv[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  open(<span class="string">&quot;input.txt&quot;</span>, O_RDONLY);</span><br><span class="line">  exec(<span class="string">&quot;cat&quot;</span>, argv);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// (echo hello; echo world) &gt;output.txt</span></span><br><span class="line"><span class="comment">// fork version: </span></span><br><span class="line"><span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// write 1 hello;</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  wait(<span class="number">0</span>); </span><br><span class="line">  <span class="comment">// write 1 world</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// dup version:</span></span><br><span class="line">fd = dup(<span class="number">1</span>);</span><br><span class="line">write(<span class="number">1</span>, );</span><br><span class="line">write(fd, );</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Processes have 3 private fds, 0 for stdin, 1 for stdout, 2 for stderr.</p>
<ul>
<li><code>read</code>, <code>write</code>: returns 0 if data r/w completes, &gt; 0 if in the process, &lt; 0 if err occurs</li>
<li><code>pipe</code>: A pipe is a kernel buffer. It has a pair of fds, one for read and one for write.They share the data read from or written to.</li>
</ul>
</li>
</ol>
<h3><span id="pipe">Pipe</span><a href="#pipe" class="header-anchor">¶</a></h3>
<ol>
<li>
<p>The read on the pipe blocks until it’s improssible to receive new data.</p>
<p>If stdin is associated with either end of pipe, then exec will wait if there is the new data waiting to r/w. So the pipe ends before write/read are alway closed in this chunk.</p>
<ul>
<li>Pipe[0] read, pipe[1] write.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wc &lt; &quot;hello world&quot;</span></span><br><span class="line"><span class="keyword">if</span>(fork() == <span class="number">0</span>) &#123;</span><br><span class="line">	close(<span class="number">0</span>); </span><br><span class="line">	dup(p[<span class="number">0</span>]); <span class="comment">// p[0] donates its data to file descriptor 0</span></span><br><span class="line">	close(p[<span class="number">0</span>]); <span class="comment">// p[0] no longer needed in child since stdin is a copy</span></span><br><span class="line">	close(p[<span class="number">1</span>]);</span><br><span class="line">	exec(<span class="string">&quot;/bin/wc&quot;</span>, argv);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	close(p[<span class="number">0</span>]);</span><br><span class="line">	write(p[<span class="number">1</span>], <span class="string">&quot;hello world\n&quot;</span>, <span class="number">12</span>);</span><br><span class="line">	close(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Process tree: <code>grep fork sh.c | wc -l</code></p>
<p>The child process creates a pipe to connect the left end of the pipe with the right end. Fork + runcmd will then run the cmd of the left end and the right end. The right end of the pipeline can also be a pipe. Therefore a processes tree generates.</p>
<ul>
<li><code>echo hi | wc</code></li>
<li><code>sleep 10 | echo hi</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PIPE:</span><br><span class="line">  pcmd = (<span class="keyword">struct</span> pipecmd*)cmd;</span><br><span class="line">  <span class="keyword">if</span>(pipe(p) &lt; <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(fork1() == <span class="number">0</span>)&#123;</span><br><span class="line">    ... <span class="comment">//p[1]</span></span><br><span class="line">    runcmd(pcmd-&gt;left);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(fork1() == <span class="number">0</span>)&#123;</span><br><span class="line">    ... <span class="comment">//p[0]</span></span><br><span class="line">    runcmd(pcmd-&gt;right);</span><br><span class="line">  &#125;</span><br><span class="line">... <span class="comment">// close pipe ends</span></span><br><span class="line">  wait(<span class="number">0</span>);</span><br><span class="line">  wait(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Pipe vs temp files: in memory vs in disk</p>
<ul>
<li><code>echo hello world | wc</code></li>
<li><code>echo hello world &gt;/tmp/xyz; wc &lt;/tmp/xyz</code></li>
</ul>
</li>
</ol>
<h3><span id="fs">Fs</span><a href="#fs" class="header-anchor">¶</a></h3>
<ol>
<li>
<p>Fs -&gt; data files -&gt; File/Dir -&gt; filename + inode -&gt; type +length + location + Links -&gt; (filename, reference/to/inode)</p>
</li>
<li>
<p>Find file: path/to/file, <code>/</code> is the root path; relative path.</p>
</li>
<li>
<p>Create file/device file: <code>mkdir</code>, <code>mknod</code>. Mknod associates kernel device with the major and the minor device numbers. The kernel diverts syscalls to the device implementation instead of fs.</p>
</li>
<li>
<p>A file has an underlying file called inode. It cantains metadata.</p>
<ul>
<li><code>fstat</code></li>
</ul>
</li>
<li>
<p>Fs utilities are user-level programs. The command line interfaces can add the same user-level programs to provide such utilities. However,<code>cd</code> is built into the shell because the forked child process cannot change the memory of the parent process.</p>
</li>
</ol>
<h2><span id="organization">Organization</span><a href="#organization" class="header-anchor">¶</a></h2>
<ol>
<li>Os MUST provides time-sharing resources and applicable isolation(interact when required) among processes.
<ul>
<li>Fancy terms: <code>multiplexing, isolation, interaction</code></li>
</ul>
</li>
<li>Let’s count what does xv6 have:
<ul>
<li>1 monolithic kernel</li>
<li>many processes (the unit of isolation)</li>
<li>runs on a multi-core RISC-V microprocessor: 64-bit, “LP64” C</li>
<li>hardwares: RAM, ROM, screen, disk (simulated by qemu -machine virt)</li>
</ul>
</li>
<li>Design points:
<ul>
<li>Abstract physical resources: Library Vs Outside manager
<ul>
<li>Library: Applications access devices like a library. App decides when to leave the process.</li>
<li>Manager: Os manages who enters/leaves the process and when.</li>
</ul>
</li>
<li>Provide strong isolation: if one process is down, others should not be corrupted by it.
<ul>
<li>hw support of CPU when executes instructions: RISC-V provides three modes: <code>machine, supervisor, user</code>.</li>
<li>privileged instruction - kernel space, user-mode instruction - user space</li>
<li>A user app invoking kernel service must transit to the kernel space first: RISC-V  <code>ecall</code> . It switches CPU u -&gt; k and enters k at an entry point controlled by k</li>
</ul>
</li>
<li>What part of os runs in supervisor mode:
<ul>
<li>Term: <code>monolithic kernel</code>: all. Good to coperate/share and bad side is unsafe.</li>
<li>Term: <code>microkernel</code>: part. Good side is safe and bad to coperate/share.</li>
<li>Term: Os running processes as service is called <code>server</code></li>
</ul>
</li>
</ul>
</li>
<li>Process provides strong isolation
<ul>
<li>mechanisms implementing process: user/super mode flag, address spaces, time-slicing of threads</li>
<li>hw support: Xv6 manages process memory via page tables (RISC-V support).</li>
</ul>
</li>
<li>Process internals:
<ul>
<li>Process has private memory system/address space. An address space contains user memory starting at va 0. Xv6 uses 38 bits of 39 bits. Max address is 2^38 - 1.<br>
| user text and data | user stack |  heap| trapframe|trampoline|<br>
0 ------------------------------------------------------------&gt;                              MAXVA</li>
<li>Process has kernel states and user states. Kernel states are its pgtbl, kernel stack, run state.</li>
<li>A process has a <u>thread</u> of execution that <u>executes the process’s instructions</u>. Thread state (local variables, function call,return address) is stored on the thread’s stacks.</li>
<li>A process has two stacks: u stack, k stack.</li>
<li>A process makes sys call by <code>ecall</code>, exit k space by <code>sret</code>.</li>
</ul>
</li>
<li>I/O path
<ul>
<li>Initialization: console,  vm stuff (page table,process table, trap vector, interrupt handler, device interrupts), fs stuff (buffer cache, inode cache, file table, hard disk)</li>
<li>Boot xv6 and start the first process
<ul>
<li>RISC-V Machine mode -&gt; Supervisor mode; xv6 jumps to kernel space<img src="/sg/2022/04/01/os_basics/boot.png" class title="boot"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h2><span id="virtual-memory-techniques">Virtual memory techniques</span><a href="#virtual-memory-techniques" class="header-anchor">¶</a></h2>
<h3><span id="page-table">Page table</span><a href="#page-table" class="header-anchor">¶</a></h3>
<ol>
<li>
<p>paging hardware:</p>
<ul>
<li>terms
<ul>
<li>RISC-V hw supports page table. Its instructions deals with <code>va</code>.</li>
<li>Sv39 RISC-V only uses the bottom 39 bits to represent <code>va</code>.</li>
<li>Storage cell DRAM is where r/w physical memory.</li>
<li>Virtual memory is not physical as va and pa but the abstraction and machanisms to manage va and pa.</li>
</ul>
</li>
<li>geometry: <code>va</code> (39 bit) = PTE_index (27 bit) +  flag bit (12 bit). PA (56 bit) = PPN (upper 44 bits of the PTE) + offset (lower 12 bits of VA). 2^27 = # of PTE.</li>
<li><code>satp</code>: supervisor address translation and protection, reserves the <code>pa</code> of page tables.
<ul>
<li>
<img src="/sg/2022/04/01/os_basics/pt.png" class title="pt">   
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Cache of (VA, PA) is Translation Lookside Buffer when finding PA for the VA</p>
<ul>
<li>TLB will be cleared when switching page table. RISC-V instruction for that is:<code>sfence_vma</code></li>
</ul>
</li>
<li>
<p>Address space:</p>
<ul>
<li>
<p>Xv6 maintains 1 page table per process in the user space and 1 page table for kernel space.</p>
</li>
<li>
<p>Kernel uses <u>direct mapping</u> to get access to RAM and memory mapped devices.</p>
</li>
<li>
<p>Not directly mapped: high-memory mapping</p>
<ul>
<li>trampoline page</li>
<li>stack pages: have an unmapped guard page with PTE invalid.</li>
</ul>
</li>
<li>
<p>process address space and kernel address space</p>
<img src="/sg/2022/04/01/os_basics/vm.png" class title="vm">     
<ul>
<li>
<p>Linux user space<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>:</p>
<img src="/sg/2022/04/01/os_basics/Screenshot-4834686.png" class title="Screenshot-4834686">  
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>I/O path</p>
<ul>
<li>physical memory allocation: free pages are stored in the linked list.</li>
<li>Syscall
<ul>
<li>sbrk: grow/shrink the memory</li>
<li>exec: create the user part of an address space</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2><span id="traps">Traps</span><a href="#traps" class="header-anchor">¶</a></h2>
<h3><span id="trap-machanism">Trap machanism</span><a href="#trap-machanism" class="header-anchor">¶</a></h3>
<ol>
<li>What: <code>trap</code> refers to event that mandatorily forces a transfer of control from the execution of ordinary instructions to special code that handles the event. Three kinds of such event are.syscalls, exception and device interrupt.
<ul>
<li>syscalls: <code>ecall</code></li>
<li>exception: u/k illegal instruction, e.g. divide by zero, invalid virtual address</li>
<li>device interrupt: device signals when r/w req finishes</li>
</ul>
</li>
<li>RISC-V machinery:
<ul>
<li>The kernel writes address/value to registers to control io path (risc-v detects regs)
<ul>
<li><code>stvec</code>, addr of trap handler</li>
<li><code>sepc</code>, risc-v saves program counter when a trap occurs. <code>sret</code> copies <code>sepc</code> to <code>pc</code> when returned from trap.</li>
<li><code>scause</code>, risc-v saves the cause of the trap</li>
<li><code>sscratch</code>, a value at the start of a trap handler (as from scratch)</li>
<li><code>sstatus</code>, <code>SIE</code> set if interrupts are enabled. <code>SPP</code> tells user/supervisor mode a trap came from and controls what <code>sret</code> returns</li>
</ul>
</li>
<li>The registers related to traps handled in supervisor mode. Xv6 has a similar set of registers for traps handled in machine mode.</li>
<li>Each CPU has its own set of registers. &gt;=1 CPU may be handling a trap at anytime.</li>
<li>Procedures of risc-v h/w: if an interrupt -&gt; no, disable SIE -&gt; <code>pc =&gt; sepc</code>, <code>sw SPP =&gt; sstatus</code> -&gt; set scause, su mode -&gt; <code>stvec =&gt; pc</code> -&gt; execute new pc</li>
</ul>
</li>
<li>Trap machanism
<ul>
<li>
<img src="/sg/2022/04/01/os_basics/trap.png" class title="trap">
</li>
</ul>
</li>
<li>Traps from user space</li>
<li>Traps from kernel space</li>
</ol>
<h3><span id="page-fault-exceptions">Page fault exceptions</span><a href="#page-fault-exceptions" class="header-anchor">¶</a></h3>
<ol>
<li>lazy allocation</li>
<li>Copy-on-write</li>
<li>demand paging</li>
<li>memory mapped file</li>
</ol>
<h3><span id="device-interrupts">Device interrupts</span><a href="#device-interrupts" class="header-anchor">¶</a></h3>
<ol>
<li>Interrupts are one type of trap. Trap handler recognizes a device interrupt and calls the driver’s interrupt handler.</li>
<li>Device drivers execute in two contexts:
<ul>
<li><code>Top half</code>: run in a process’s kernel thread, read/write()</li>
<li><code>Bottom half</code>: interrupt handler copies the input data to buffer and wake up top-half code to do op. It runs in the <code>interrupt context</code> which is also referred to <code>atomic context</code>, unable to block.</li>
<li>Linux has opposite names for those two contexts.</li>
</ul>
</li>
<li>Terms
<ul>
<li><code>interrupt context</code> is time-critical that is not associated with processes. Interrupt handler putting one process sleep may let other process blocking therefore it cannot sleep in this context.</li>
<li><code>process context</code> is the mode of operation the kernel is in while it is executing on behalf of a process (LKD3 Chap7). Process can sleep or invoke the schedulor</li>
</ul>
</li>
<li>Driver is programmed by memory mapped I/O.</li>
<li>How xv6 displays “$” in console?<br>
device -&gt; (uart-&gt;interrupt -&gt;) console</li>
<li>How xv6 displays “ls” in console?<br>
key stroke -&gt; keyboard -&gt; (uart input -&gt; merge to byte -&gt; interrupt)-&gt;interrupt handler</li>
<li>Riscv interrupts related registers: SIE(supervisor interrupt enable), SSTATUS(supervisor status), SIP(supervisor interrupt pending), SCAUSE: means interrupts, STVEC: program counter of user program that cpu runs when trap/interrupts/page faults occur</li>
<li>timer interrupts: to maintain its clock and enable it to switch among processes. Execute in the machine mode.
<ul>
<li>CLINT (core-local interruptor)</li>
<li>time-slice CPU</li>
</ul>
</li>
<li>Interrupts have high CPU overhead, ways to reduce the need for interrupts
<ul>
<li>single interrupt for a batch of incoming requests</li>
<li>disable interrupts and check the device for attention: <code>polling</code>, wastes CPU time when the device is mostly idle</li>
<li>dynamically switch between interrupts and polling</li>
</ul>
</li>
<li>Date movement to h/w
<ul>
<li>programmed I/O: UART driver, kernel buffer =&gt; user buffer =&gt; h/w, low speed</li>
<li>DMA (direct memory access): most modern drivers, user-space buffers &lt;=&gt; device hardware, high speed</li>
</ul>
</li>
</ol>
<h2><span id="parallelism">Parallelism</span><a href="#parallelism" class="header-anchor">¶</a></h2>
<h3><span id="lock">Lock</span><a href="#lock" class="header-anchor">¶</a></h3>
<ol>
<li>Xv6 has two locks: spinlocks and sleeplocks
<ul>
<li>spinlocks
<ul>
<li>continue polling for the lock. Hold a lock for a short time. Cannot <code>yield CPU</code> (a thread switch).</li>
<li>Cost: polling</li>
<li><strong>disable interrupts</strong>: if a lock can be interruptted, then the interrupt acquires the same lock that is being used which leads to dead lock.  -&gt; concurrency in same CPU</li>
<li>sw vs atomic_swap: sw differs in different CPU settings. It may have one more instruction which disables the atomicity. -&gt; concurrency in different CPU</li>
</ul>
</li>
<li>Sleeplocks:
<ul>
<li>sleep until certain condition occurs. Hold a lock for a long time. Can yield CPU. (ex, mutex)</li>
<li>Cost: high CPU overhead due to context switch (open another kernel thread)</li>
<li><code>locked</code>, a word that is zero when the lock is available and non-zero when it is held.</li>
</ul>
</li>
</ul>
</li>
<li>Why locks: one data stucture are accessed by multiple processes(race condition) -&gt; atomicity in critical section.</li>
<li>How? system designers should define orders of locks for the purpose of performance and correctness</li>
<li>memory barrier: tells the compiler and CPU to <strong>not reorder</strong> loads or stores across the barrier, <code>__sync_synchronize()</code></li>
</ol>
<p>Scenario 1: race condition in kfree()</p>
<p>Attempt 1: corse-grain locking/two processs are accessing one sharing data structure and one of them updates the data.</p>
<p>scenario 2: rename files: rename(“d1/x”, “d2/y”)</p>
<p>Attempt 2: lock operations not data structures.</p>
<p>Terminology:</p>
<ol>
<li>Deadlock: unlocking A requires B, unlocking B requires A, A and B are locked. example: deadly embrace</li>
</ol>
<h3><span id="threads">Threads</span><a href="#threads" class="header-anchor">¶</a></h3>
<ol>
<li>
<p>Why threads? Run parallel programs</p>
</li>
<li>
<p>What: One thread is the state of one serial execution. Thread states include PC, REGS, STACK, [state:runnning, runable, sleeping]</p>
</li>
<li>
<p>How: problems of implementing threads</p>
<p>Assumption: one core(CPU) one thing -&gt; thread either sleeps or runs on one core</p>
<ul>
<li>how to switch between processes(scheduling)</li>
<li>What to save and restore in switching</li>
<li>Compute-bound threads: long-running program</li>
</ul>
</li>
<li>
<p>Cooperative scheduling is user processes explicitly give up control to kernel</p>
</li>
<li>
<p>Scheduling policies:</p>
<ul>
<li>+priority: fairness Vs throughput
<ul>
<li><code>priority inversion</code>: low-priority process and high-priority process share a lock</li>
<li><code>convoys</code>: many high-priority processes are waiting for a low-priority process that acquires a shared lock</li>
</ul>
</li>
<li>implementation: sleep+wakeup
<ul>
<li><code>sleep</code> disabled interrupts -&gt; single-CPU</li>
<li><code>sleep</code> + lock -&gt; xv6 (multiprocessor systems), FreeBSD</li>
<li>use explicit process queue,<code>waitqueue</code> -&gt; Linux</li>
</ul>
</li>
<li><code>wakeup:signal</code>, wakeup one/all process
<ul>
<li>many processes are waiting for that particular channel, <code>thundering herd</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>scheduler</p>
<ul>
<li>coroutines: xv6 switches threads following a patten as scheduler:swtch(&amp;c-&gt;context, &amp;p-&gt;context) -&gt; sched:swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;context) -&gt; scheduler:swtch -&gt; sched:swtch … <code>sched</code> and <code>scheduler</code> are coroutines of each other.</li>
<li>xv6 holds <strong>p-&gt;lock</strong> in <code>swtch</code>: acquires p-&gt;lock in one thread and releases it in other.</li>
</ul>
</li>
</ol>
<p>Problem1: what if the process runs for a long time?</p>
<p>-&gt; [Pre-emptive scheduling]  the process is:</p>
<ul>
<li>user processes run</li>
<li>time interrupts make it give up control to kernel</li>
<li>kernel then yields the CPU</li>
</ul>
<p>Problem2: lost wake-up problem, wakeup before sleeping and no wakeup while sleeping</p>
<ul>
<li>another process blocking (acquire lock that is not released by sleep(object)) while sleeping -&gt; Fixed by sleep(lock, object). Sleep will realese the lock after sleeping. It holds the lock before sleeping.</li>
<li>sleep/wakeup + spinlock, a synchronization method</li>
</ul>
<p>Example of <u>context switching</u> <code>swtch</code> between a kernel thread and a scheduler thread (kernel/proc.c):</p>
<ul>
<li>
<p>Stack pointer, program counter: CPU switchs stacks and switch executing code; the xv6 scheduler has a dedicated <strong>thread (saved registers and stack)</strong> per CPU. A register set calls <code>context</code></p>
</li>
<li>
<p>Switching plan: swtch saves ra, sp where swtch was called and current context in p-&gt;context. Then it restores regs from new context.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># sched:swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;context);</span><br><span class="line">swtch:</span><br><span class="line">        sd ra, 0(a0)</span><br><span class="line">        sd sp, 8(a0) # sw contents of sp, Offset(RegSource)</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        ld ra, 0(a1) # ld RegDest, Offset(RegSource)</span><br><span class="line">        ld sp, 8(a1)</span><br><span class="line">        ...</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2><span id="file-systems">File systems</span><a href="#file-systems" class="header-anchor">¶</a></h2>
<p>Design points:</p>
<ol>
<li>on-disk data structures for dir and files tree</li>
<li>crash recovery</li>
<li>coordinate multi-process to maintain invariants</li>
<li>in-memory cache for fast retrieval of data</li>
</ol>
<img src="/sg/2022/04/01/os_basics/Screenshot-6244321.png" class title="A file on disk">
<h2><span id="case-study-ext3">case study: ext3</span><a href="#case-study-ext3" class="header-anchor">¶</a></h2>
<h2><span id="network-stack">Network stack</span><a href="#network-stack" class="header-anchor">¶</a></h2>
<h2><span id="case-study-meltdown">case study: meltdown</span><a href="#case-study-meltdown" class="header-anchor">¶</a></h2>
<h2><span id="case-study-rcu">case study: RCU</span><a href="#case-study-rcu" class="header-anchor">¶</a></h2>
<p>Readings:</p>
<ol>
<li>RCU Usage In the Linux Kernel: One Decade Later, 2013</li>
<li>LWN<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>: rcu basics, <a target="_blank" rel="noopener" href="https://lwn.net/Articles/262464/">https://lwn.net/Articles/262464/</a></li>
</ol>
<p>Terms:</p>
<ol>
<li>detry, directory entry metadata</li>
<li>NMI, non maskable interrupts (cannot be disabled)</li>
<li>type safe memory is memory that keeps its type after being deallocated.</li>
<li>explicit tracking includes reference counts, reader-writer locks, events, etc.</li>
</ol>
<blockquote>
<p>The most basic form of RCU is a way of waiting for things to finish. … The greatest advantage of RCU is that it can wait for each of 20,000 different things without having to explicitly track each and every one of them, and without worrying about performance, deadlock scenarios and memory-leak hazards etc. that are inherent in schemes using explicit tracking.</p>
</blockquote>
<p>RCU is faster than other synchronization mechanisms in the kernel by allowing a single updater and multiple readers. It caters three needs: read while updating, low computation + storage overhead (a few bytes/dentry) and deterministic completion.</p>
<h3><span id="design">Design</span><a href="#design" class="header-anchor">¶</a></h3>
<ol>
<li>It has a read-side critical section and a synchronization section.
<ul>
<li>Read_lock, read_unlock: By disabling thread preemption (a thread cannot context switch in the critical section). Can be called many times. -&gt; non-blocking</li>
<li>call_rcu, synchronize_rcu: wait for the completion of all the previous caller of rcu into the critical section. It does not wait for the caller after synchronize_rcu is invoked.</li>
</ul>
</li>
<li>The design is based on scheduler context switch, maintaining state shared between CPUs.</li>
<li>Handles compiler and memory reordering (processor) carefully. Assign_pointer, dereference.</li>
<li>RCU maintains multiple versions of objects and only frees them until all pre-existing critical sections completes.</li>
</ol>
<h3><span id="mechanisms">Mechanisms</span><a href="#mechanisms" class="header-anchor">¶</a></h3>
<ol>
<li>
<p>publish-subscribe: enforce ordering for insertions and reads</p>
<p>This mechanism is designed to cope with behaviors of CPU and compiler.</p>
<ul>
<li>There is not guarantee that the sequential assignments are in-order from the views of compiler and CPU. <code>Rcu_assign_pointer</code> enforces the assignment of gp is the last one of current assignments.</li>
<li>The value-speculation compiler optimizations: compiler guesses p, fetches p-&gt;a, p-&gt;b and p-&gt;c, then fetches the actual p value to check if the guess is right. <code>Rcu_dereference</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #1 publication: allow assignment without values uninitialized </span></span><br><span class="line"><span class="comment">// and avoid using memory barriers.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">  <span class="type">int</span> b;</span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">gp</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">p = kmalloc(size, GFP_kernel);</span><br><span class="line">p-&gt;a = <span class="number">1</span>;</span><br><span class="line">p-&gt;b = <span class="number">2</span>;</span><br><span class="line">p-&gt;c = <span class="number">3</span>;</span><br><span class="line">rcu_assign_pointer(gp, p) <span class="comment">// gp = p</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// #2</span></span><br><span class="line">p = gp;</span><br><span class="line"><span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">  do_something_with(p-&gt;a, p-&gt;b, p-&gt;c);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// subscribtion: subscribe to a given value of the specifiled pointer </span></span><br><span class="line"><span class="comment">// and make sure the deference ops see initialization before any </span></span><br><span class="line"><span class="comment">// publish op</span></span><br><span class="line">rcu_read_lock();</span><br><span class="line">p = rcu_dereference(gp);</span><br><span class="line"><span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">  do_something_with(p-&gt;a, p-&gt;b, p-&gt;c);</span><br><span class="line">&#125;</span><br><span class="line">rcu_read_unlock();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>wait for pre-existing rcu readers to complete, for deletion</p>
<ul>
<li>It is implied that read-side critical sections have completed before the next context switch. Because no sleep or blocking is allowed in the critical sections.</li>
<li>A grace period waits for completion of pre-existing reads and will extend as needed.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">  <span class="type">int</span> a;</span><br><span class="line">  <span class="type">int</span> b;</span><br><span class="line">  <span class="type">int</span> c;</span><br><span class="line">&#125;;</span><br><span class="line">LIST_HEAD(head);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* . . . */</span></span><br><span class="line">p = search(head, key);</span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">  <span class="comment">/* Take appropriate action, unlock, and return. */</span></span><br><span class="line">&#125;</span><br><span class="line">q = kmalloc(<span class="keyword">sizeof</span>(*p), GFP_KERNEL);</span><br><span class="line"><span class="comment">// read-copy-update: copies</span></span><br><span class="line">*q = *p; </span><br><span class="line"><span class="comment">// and updates</span></span><br><span class="line">q-&gt;b = <span class="number">2</span>; </span><br><span class="line">q-&gt;c = <span class="number">3</span>;</span><br><span class="line">list_replace_rcu(&amp;p-&gt;<span class="built_in">list</span>, &amp;q-&gt;<span class="built_in">list</span>);</span><br><span class="line"><span class="comment">// do context_switch() on each CPU.</span></span><br><span class="line">synchronize_rcu();</span><br><span class="line">kfree(p);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>multiple versions of recently updated objects, for reader</p>
<ul>
<li>Deletion example: two versions of one pointer values are only kept in the critical sections. After exiting, on readers references that pointer and it will be safely freed.</li>
</ul>
</li>
</ol>
<h3><span id="usages">Usages</span><a href="#usages" class="header-anchor">¶</a></h3>
<ol>
<li>wait for completion. Put a spin_lock around rcu critical section. The NMI sys runs every NMI handler in the critical section.</li>
<li>reference counting. Users of the data item execute in the critical section. When freeing a data item, use call_rcu to free the memory after no other threads using the data item. It’s efficient for getting rid of updates, memory barriers, atomic operations, etc…</li>
<li>type safe memory. Reverse page map maps a physical page (page_t) to all the virtual address (anon_vma_t) mappings that include that physical page.   Deallocating a page without waiting for all threads to relinquish the pointer to the page.</li>
<li>publish-subscribe. Rcu_assign_pointer publishes a pointer and concurrent readers read through rcu_dereference.</li>
<li>read-write lock alternative. Read in the critical section, write synchronize with other writes using spin locks.</li>
</ol>
<h2><span id="basics">Basics</span><a href="#basics" class="header-anchor">¶</a></h2>
<h3><span id="c">C</span><a href="#c" class="header-anchor">¶</a></h3>
<ol>
<li>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8011700/how-do-i-extract-specific-n-bits-of-a-32-bit-unsigned-integer-in-c">bit mask</a>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Want the last X bits</span></span><br><span class="line"><span class="type">unsigned</span>  mask;</span><br><span class="line">mask = (<span class="number">1</span> &lt;&lt; X) - <span class="number">1</span>; <span class="comment">// -1 is like fliping the bit</span></span><br><span class="line">lastXbits = value &amp; mask;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Want X bits in the middle</span></span><br><span class="line"><span class="type">unsigned</span>  mask;</span><br><span class="line">mask = ((<span class="number">1</span> &lt;&lt; X) - <span class="number">1</span>) &lt;&lt; startBit;</span><br><span class="line">isolatedXbits = value &amp; mask;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>struct vs packed struct: if the fileds aligned</p>
<ul>
<li>Fact: misaligned load/store can be slow or unsupported (platform-dependent)</li>
</ul>
</li>
</ol>
<h3><span id="risc-v-convention">RISC-V convention</span><a href="#risc-v-convention" class="header-anchor">¶</a></h3>
<p>Understanding RISC-V Calling Convention by Nick Riasanovsky:</p>
<ol>
<li>
<p>RISC-V abstract machine: Base ISA: Program counter, 32 general-purpose registers (x0–x31).</p>
<ul>
<li>
<p>Unlike high-level programming language, convention is a choice to organize code like naming and line &lt; 80. Assembly is built on convention. Three parts is key to understand assembly: <strong>registers, function calls, and entering/exiting a function (prologue/epilogue)</strong>.</p>
</li>
<li>
<p>.section; .global means it can call this function from other files; .text means it’s executable code<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p>
</li>
</ul>
</li>
<li>
<p>Registers</p>
<ul>
<li>RISC-V has 32 registers. <code>sp</code> holds the current base of the stack. <code>ra</code> return address. <code>pc</code> holds the address of the current instruction.  <code>t</code> for temporary. <code>a</code> regs -&gt; 8 arguments, 2 return values in <code>a0-a1</code>.
<ul>
<li>
<img src="/sg/2022/04/01/os_basics/Screenshot-9679149.png" class title="Screenshot-9679149">
</li>
<li><code>f</code> reg for floating point</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Function calls</p>
<ul>
<li>Used after a function call(), <code>s</code> regs; unused after a call(), <code>t</code> regs.</li>
<li>(not persistent) Making a call, pass arguments in <code>a2-a7</code>; (persistent) after a call, get return values in <code>a0-a1</code></li>
</ul>
</li>
<li>
<p>Prologue/Epilogue</p>
<ul>
<li>
<p>guarantees:</p>
<blockquote>
<ul>
<li>The sp will have the same value when exiting the function that it did entering (unless we store return values on the stack).</li>
<li>All s registers will have the same value exiting the function that they did entering.</li>
<li>The function will return to the value stored in ra, assuming no abnormal execution.</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def prologue():</span><br><span class="line">	sp -= space of (s registers + local var);</span><br><span class="line">	store any saved regs used;</span><br><span class="line">	store ra if call();</span><br><span class="line"></span><br><span class="line">def epilogue():</span><br><span class="line">	reload any saved regs;</span><br><span class="line">	reload ra;</span><br><span class="line">	sp = previous sp;</span><br><span class="line">	jump back to return address</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>Stack Frames: stack grows downwards and heap grows upwards</p>
<ul>
<li>return address, to prev.frame(fp), saved registers, local variables… (higher &lt;- lower addr)</li>
</ul>
</li>
<li>
<p>Why this convention? Avoid to save every regs</p>
</li>
<li>
<p>Debug tips using convention</p>
<blockquote>
<ul>
<li>Check that you stored <code>ra</code> properly. For recursion make sure you link <code>ra</code> for each recursive call. You can test this by putting a break point at the end of the epilogue and seeing where you return.</li>
<li>Check that you don’t use any <code>t</code> registers after a function call.</li>
<li>Check that <code>sp</code> enters and exits with the same value.</li>
<li>Check the number of times you enter the prologue equals the number of times you enter the epilogue.</li>
<li>Make sure you restore every register you modified.</li>
</ul>
</blockquote>
</li>
<li>
<p>Instructions</p>
<ul>
<li>
<p><code>w</code> (word) is 32 bit in RISC-V, <code>d</code> (double) is 64 bit, <code>i</code> (immediate) is constant (see 6.004 isa reference card for the maximum value it can represent)</p>
</li>
<li>
<p>Reg is 32-bit (4 byte) wide in RV32; 64 bit in RV64 etc.</p>
</li>
<li>
<p><code>ra</code> is the destination reg</p>
</li>
<li>
<p><code>csrr</code>: Read CSR (Control System Register)</p>
</li>
<li>
<p><code>mhartid</code> is Hart ID Register: The mhartid CSR is an MXLEN-bit read-only register containing the integer ID of <u>the hardware thread running the code</u> (Riscv privileged spec 3.1.5)</p>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">csrr a1 mhartid</span><br><span class="line">csrr rd, csr  -&gt; csrrs rd, csr, x0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>jal</code>, jump and link; <code>jalr</code>, jump and link register;</p>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// call()</span><br><span class="line">jal ra lable // link ra with pc + 4 (store pc + 4 in ra), jump to lable (pc = lable); </span><br><span class="line">jalr ra rd imm // link ra with pc + 4, jump to reg (pc = rd + imm)</span><br><span class="line"></span><br><span class="line">// no call(), just jump to lable</span><br><span class="line">jal x0 lable // j lable</span><br><span class="line">jalr x0 rd imm // jr rd imm</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3><span id="gdb">GDB</span><a href="#gdb" class="header-anchor">¶</a></h3>
<p>gdb notes from lecture and csapp, <a target="_blank" rel="noopener" href="https://sourceware.org/gdb/onlinedocs/gdb/">more</a>:</p>
<ol>
<li>
<p><code>file filename</code>: read symbols from that file</p>
</li>
<li>
<p>show source code:<code>tui enable</code>, <code>layout split</code> -&gt; both C and asm,  <code>layout source</code> -&gt; only C</p>
<ul>
<li><code>layout reg</code>, <code>layout asm</code>: show reg, assembly</li>
<li><code>layout next</code>: steps through layouts</li>
</ul>
</li>
<li>
<p>info: breakpoints, program, functions, stack, frame, registers,</p>
<ul>
<li><code>info b</code></li>
</ul>
</li>
<li>
<p>execution: <code>step</code>, <code>continue</code>, <code>finish</code>, <code>run</code>, <code>until</code></p>
<ul>
<li>
<p><code>until 3</code>: run until breakpoint 3</p>
</li>
<li>
<p><code>si</code>: execute one instruction</p>
</li>
</ul>
</li>
<li>
<p>breakpoints: you can disable/enble, break/delete it</p>
<ul>
<li>conditional breakpoints: break, only when a condition holds (e.g. variable has a certain value)</li>
<li><code>clear sum</code>: Clear any breakpoints at the entry to function sum</li>
</ul>
</li>
<li>
<p>watchpoints: break when a memory location changes value, <code>wa</code></p>
<ul>
<li><code>watch -l address</code>: when the address contents change</li>
<li><code>watch expression</code>: when expression changes</li>
</ul>
</li>
<li>
<p>examine data:</p>
<ul>
<li><code>print /[format] $rax</code></li>
<li><code>print /d (int)$rax</code>: Print contents of %rax in decimal after sign-extending lower 32-bits. -&gt; negative value</li>
<li><code>print *(int *) 0xbffff890</code>: Print integer at address 0xbffff890</li>
<li><code>print *(int *) ($rsp+8)</code> : Print integer at address %rsp + 8</li>
<li><code>print (char *) 0xbfff890</code>: Examine a string stored at 0xbffff890</li>
<li><code>x/[num][size][format] where </code>:  <code>num</code>, number of objects to display, <code>size</code> = size of each object (b=byte, h=half-word, w=word, g=giant (quad-word)), <code>format</code> = how to display each object (d=decimal, x=hex, o=octal, t=binary etc.)</li>
</ul>
</li>
</ol>
<h3><span id="lookup-table">Lookup table</span><a href="#lookup-table" class="header-anchor">¶</a></h3>
<p>RISC-V regs:</p>
<table>
<thead>
<tr>
<th>reg</th>
<th style="text-align:center">name</th>
<th>saver</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>x0</td>
<td style="text-align:center">zero</td>
<td>-</td>
<td>hardwired zero, always 0</td>
</tr>
<tr>
<td>x1</td>
<td style="text-align:center">ra</td>
<td></td>
<td>return address</td>
</tr>
<tr>
<td>x2</td>
<td style="text-align:center">sp</td>
<td>callee</td>
<td>stack pointer</td>
</tr>
<tr>
<td>x3</td>
<td style="text-align:center">gp</td>
<td>-</td>
<td>global pointer</td>
</tr>
<tr>
<td>x4</td>
<td style="text-align:center">tp</td>
<td>-</td>
<td>thread pointer</td>
</tr>
<tr>
<td>x5-7</td>
<td style="text-align:center">t0-2</td>
<td></td>
<td>temporary registers</td>
</tr>
<tr>
<td>x8</td>
<td style="text-align:center">s0/fp</td>
<td>callee</td>
<td>saved register / frame pointer</td>
</tr>
<tr>
<td>x9</td>
<td style="text-align:center">s1</td>
<td>callee</td>
<td>saved register</td>
</tr>
<tr>
<td>x10-11</td>
<td style="text-align:center">a0-1</td>
<td></td>
<td>function arguments / return values</td>
</tr>
<tr>
<td>x12-17</td>
<td style="text-align:center">a2-7</td>
<td></td>
<td>function arguments</td>
</tr>
<tr>
<td>x18-27</td>
<td style="text-align:center">s2-s11</td>
<td>callee</td>
<td>saved registers</td>
</tr>
<tr>
<td>x28-31</td>
<td style="text-align:center">t3-6</td>
<td></td>
<td>temporary registers</td>
</tr>
<tr>
<td>pc</td>
<td style="text-align:center">-</td>
<td>-</td>
<td>program counter</td>
</tr>
</tbody>
</table>
<h2><span id="related-readings">Related readings</span><a href="#related-readings" class="header-anchor">¶</a></h2>
<ol>
<li>A nice blog explains pipe and inter-process communication in details: <a target="_blank" rel="noopener" href="https://www.rozmichelle.com/pipes-forks-dups/">https://www.rozmichelle.com/pipes-forks-dups/</a></li>
<li>risc-v examples: <a target="_blank" rel="noopener" href="https://marz.utk.edu/my-courses/cosc230/book/example-risc-v-assembly-programs/">https://marz.utk.edu/my-courses/cosc230/book/example-risc-v-assembly-programs/</a></li>
</ol>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Adrian Huang, <a target="_blank" rel="noopener" href="https://www.slideshare.net/AdrianHuang/process-address-space-the-way-to-create-virtual-address-page-table-of-userspace-application-251425396">Process address space</a>, 2022 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>Rcu <a target="_blank" rel="noopener" href="https://docs.kernel.org/RCU/index.html">doc</a>. More rcu readings: <a target="_blank" rel="noopener" href="https://docs.kernel.org/RCU/rcu.html">https://docs.kernel.org/RCU/rcu.html</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>RISC-V Assembler Reference, <a target="_blank" rel="noopener" href="https://michaeljclark.github.io/asm.html">https://michaeljclark.github.io/asm.html</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/sg/">Home</a></li>
         
          <li><a href="/sg/about/">About</a></li>
         
          <li><a href="/sg/categories/">Category</a></li>
         
          <li><a href="/sg/archives/">Writing</a></li>
         
          <li><a href="/sg/CV/">CV</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Design points</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Interfaces</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text">Process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text">File descriptor and I&#x2F;O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.3.</span> <span class="toc-text">Pipe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.4.</span> <span class="toc-text">Fs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">Organization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">Virtual memory techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">4.1.</span> <span class="toc-text">Page table</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">Traps</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.1.</span> <span class="toc-text">Trap machanism</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.2.</span> <span class="toc-text">Page fault exceptions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.3.</span> <span class="toc-text">Device interrupts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">Parallelism</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">6.1.</span> <span class="toc-text">Lock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">6.2.</span> <span class="toc-text">Threads</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">File systems</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">case study: ext3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">Network stack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">case study: meltdown</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text">case study: RCU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">11.1.</span> <span class="toc-text">Design</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">11.2.</span> <span class="toc-text">Mechanisms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">11.3.</span> <span class="toc-text">Usages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">12.</span> <span class="toc-text">Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.1.</span> <span class="toc-text">C</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.2.</span> <span class="toc-text">RISC-V convention</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.3.</span> <span class="toc-text">GDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">12.4.</span> <span class="toc-text">Lookup table</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">13.</span> <span class="toc-text">Related readings</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://sgzerolc.github.io/sg/2022/04/01/os_basics/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&text=Intro to xv6"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&is_video=false&description=Intro to xv6"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Intro to xv6&body=Check out this article: https://sgzerolc.github.io/sg/2022/04/01/os_basics/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&title=Intro to xv6"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&name=Intro to xv6&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://sgzerolc.github.io/sg/2022/04/01/os_basics/&t=Intro to xv6"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    Sam Li
  </div>
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/sg/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
